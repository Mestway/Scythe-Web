<!DOCTYPE html>
<html lang="en">
<head>
  <title>Scythe</title>
  <script src="./static/scripts/jquery-3.1.1.js" type="text/javascript" charset="utf-8"></script>

  <link href="./static/lib/bootstrap/css/bootstrap.css" rel="stylesheet" />
  <script src="./static/lib/bootstrap/js/bootstrap.js" type="text/javascript" charset="utf-8"></script>

  <link rel="stylesheet" type="text/css" href="./static/css/main.css" />
  
  <script src="./static/lib/d3/d3.js" type="text/javascript" charset="utf-8"></script>
  <script src="./static/scripts/d3-tip.js" type="text/javascript" charset="utf-8"></script>

  <script src="./static/scripts/util.js" type="text/javascript" charset="utf-8"></script>
  
  <script src="./static/lib/jquery-ui-1.12.1.custom/jquery-ui.js" type="text/javascript" charset="utf-8"></script>
  <script src="./static/scripts/jquery.fileupload.js" type="text/javascript" charset="utf-8"></script>

  <!--<script type="text/javascript" charset="utf8" src="./static/scripts/jquery.dataTables.js"></script>
  <link rel="stylesheet" type="text/css" href="./static/css/jquery.datatables.css">-->

  <script type="text/javascript" charset="utf8" src="./static/scripts/mindmup-editabletable.js"></script>
  <script type="text/javascript" src="./static/scripts/main.js"></script>

  <!-- enahnced dropdown -->
  <script type="text/javascript" charset="utf8" src="./static/lib/dropdowns-enhancement/dropdowns-enhancement.js"></script>
  <link rel="stylesheet" type="text/css" href="./static/lib/dropdowns-enhancement/dropdowns-enhancement.css" />

  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/ju/dt-1.10.13/datatables.min.css"/>
  <script type="text/javascript" src="https://cdn.datatables.net/v/ju/dt-1.10.13/datatables.min.js"></script>

</head>

<body>
  <nav class="navbar navbar-inverse navbar-static-top navbar-full">
    <div class="container-fluid">
      <div class="navbar-header">
        <div class="navbar-brand">Scythe</div> 
      </div>
      <ul class="nav navbar-nav">
        <li class="active"><a href="#">Home</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right" style="padding: 0px 15px">
        <li><button class="btn btn-primary navbar-btn">Connect</button>
            <button class="btn btn-danger navbar-btn">Disconnect</button>
        </li>
      </ul>
    </div>
  </nav>

  <!--<div id="place_holder" class="dash-box-w-text" style="width: 98%; margin: 0 auto;"> Start By Uploading Your Data.</div>-->
  <div id="wrapper">
    <div id="interactive-panels" panel-cnt="0">
      <div class="buttons">
        <button id="add_panel" class="btn btn-success"><span class="glyphicon glyphicon-plus"></span> New Panel</button>
        <button id="remove_panel" class="btn btn-danger"><span class="glyphicon glyphicon-minus"></span> Remove Panel</button>
      </div>
  </div>

  <div id="test"></div>
</body>

<script>

var input_csv = null;

$(function() {
  $('#add_panel').click(function () {

    panel_id = parseInt($("#interactive-panels").attr("panel-cnt"));
    $("#interactive-panels").attr("panel-cnt", panel_id + 1);

    output_panel_content_empty = "<tr><td>empty</td><td>empty</td><td>empty</td></tr>\
                <tr><td>empty</td><td>empty</td><td>empty</td></tr>\
                <tr><td>empty</td><td>empty</td><td>empty</td></tr>";

    output_panel_content = "<tr><td>H. Simon</td><td>1974</td><td>277</td></tr>\
                <tr><td>R. Tibshiran...</td><td>1995</td><td>51</td></tr>\
                <tr><td>P. Bork</td><td>1998</td><td>51</td></tr>";

    input_panel_content = "<tr><td>empty</td><td>empty</td><td>empty</td></tr>\
                <tr><td>empty</td><td>empty</td><td>empty</td></tr>\
                <tr><td>empty</td><td>empty</td><td>empty</td></tr>\
                <tr><td>empty</td><td>empty</td><td>empty</td></tr>";

    panel_frame = 
      "<table panel_id='" + panel_id + "' id=\"panel"  + panel_id + "\" class=\"ipanel dash-box\" style=\"width:100%;table-layout: fixed;\">\
        <tr>\
          <td style='width: 35%;vertical-align:top;border-right:1px dashed gray;'>\
            <div class=\"input-example\" sub_panel_cnt='1' id=\"input-example" + panel_id + "\">\
              <div id=\"input-example" + panel_id +  "sub" + 1 + "\"></div>\
            </div>\
            <div id='constraint-panel" + panel_id + "'>\
              <div class='input-group input-group-sm input-box constant-panel'>\
                <span class='input-group-addon' id='basic-addon1" + panel_id + "'>Constants</span>\
                <input type='text' class='form-control' placeholder='None' aria-describedby='basic-addon1" + panel_id + "'>\
              </div>\
              <div class='input-group input-group-sm input-box aggr-func-panel'>\
                <span class='input-group-addon' id='basic-addon2" + panel_id + "'>Aggregators</span>\
                <input type='text' class='form-control' placeholder='None' aria-describedby='basic-addon2" + panel_id + "'>\
              </div>\
            </div>\
          </td>\
          <td style='width: 20%;vertical-align:top;'>\
            <div class=\"output-example\" id=\"output-example" + panel_id + "\"></div>\
          </td>\
          <td style='width: 43%;vertical-align:top;'>\
            <div class=\"vis\"  id=\"display-panel" + panel_id + "\">\
              <div class=\"pnl display-query\" style=\"display:none\"></div>\
              <div vis_type=\"histogram\" class=\"pnl display-vis\" style=\"display:block;\"></div>\
            </div>\
          </td>\
        </tr>\
        <tr style='height:0px;'>\
          <td style='border-right:1px dashed gray;'><div current_panel_id=\"" + panel_id + "\" id=\"input-panel-btns" + panel_id + "\"></div></td>\
          <td><div id='synthesize-btn-container" + panel_id + "'></div></td>\
          <td style=\"text-align:center;\"><div class=\"buttons btn-group\" style='margin:0 auto; padding-left:10px;padding-right:10px;'>\
                <div class='btn-group' id='query-choice" + panel_id + "'>\
                  <label class=\"btn btn-default query-btn\">Query</label>\
                  <label data-toggle='dropdown' class='viz-query-choice btn btn-default dropdown-toggle' data-placeholder=\"false\"><span class='caret'></span></label>\
                  <ul class='dropdown-menu' ></ul>\
                </div>" +
                // below is the visualization choice panel, note that items in the list should all have the same name
                "<div class='btn-group' id='vis-choice" + panel_id + "'>\
                  <label class=\"btn btn-default vis-btn\">Visualization</label>\
                  <label data-toggle='dropdown' class='btn btn-default dropdown-toggle' data-placeholder=\"false\"><span class='caret'></span></label>\
                  <ul class='dropdown-menu'>\
                    <li>\
                      <input type='radio' id='vis_data_" + panel_id + "_1' name='vis_data_" + panel_id + "' value='1' checked>\
                      <label for='vis_data_" + panel_id + "_1'>Example Output</label>\
                    </li>\
                    <li>\
                      <input type='radio' id='vis_data_" + panel_id + "_2' name='vis_data_" + panel_id + "' value='2'>\
                      <label for='vis_data_" + panel_id + "_2'>Full Output</label>\
                    </li>\
                    <li class='divider'></li>\
                    <li>\
                      <input type='radio' id='vis_type_" + panel_id + "_1' name='vis_type" + panel_id + "' value='1' checked>\
                      <label for='vis_type_" + panel_id + "_1'><i class='icon-edit'></i> Histogram</label>\
                    </li>\
                    <li>\
                      <input type='radio' id='vis_type_" + panel_id + "_2' name='vis_type" + panel_id + "' value='2'>\
                      <label for='vis_type_" + panel_id + "_2'><i class='icon-remove'></i> 3D Histogram</label>\
                    </li>\
                  </ul>\
                </div>\
              </div></td>\
        </tr>\
      </table>\
      <br/>";

    // add the frame into the panel
    $("#interactive-panels").append(panel_frame);

    input_example_id = "input-example" + panel_id;
    output_example_id = "output-example" + panel_id;
    synthesize_btn_id = "synthesize_btn" + panel_id;
    fileupload_id = "fileupload" + panel_id;

    // add an input table to the input table panel, this is the first sub table in the panel
    gen_adjustable_table_div("input-example" + panel_id + "sub" + 1, "itable_" + panel_id + "_" + 1 );
    // add an output table to the output table panel
    gen_adjustable_table_div("output-example" + panel_id, "otable_" + panel_id);
    // generate buttons for the input panel, include an "add table button" and an load table button
    gen_input_panel_btn("input-panel-btns" + panel_id, 
                        "itable_upload_btn_" + panel_id, 
                        "itable_" + panel_id + "_" + 1);
    // generate the button for the output panel, it is the "synthesize" button
    gen_synthesize_btn("synthesize-btn-container" + panel_id, "synthesize-btn" + panel_id, 
                       ["itable_" + panel_id + "_" + 1], "otable_" + panel_id, 
                       "constraint-panel" + panel_id, "display-panel" + panel_id);

    vis_type_choice_id = "vis-type-choice" + panel_id;
    vis_data_choice_id = "vis-data-choice" + panel_id

    query_choice_id = "query-choice" + panel_id;
    vis_choice_id = "vis-choice" + panel_id;

    $(function() {
      $("#" + query_choice_id + " .query-btn").click(function () {
        // get the query choice id
        query_choice_id = $(this).closest("div").prop("id");
        id = query_choice_id.substring(query_choice_id.length-1);
        $("#display-panel" + id + " .display-query").attr("style", "display: block; width:100%;");
        $("#display-panel" + id + " .display-vis").attr("style", "display: none");
      });

      $("#" + vis_choice_id + " .vis-btn, " + "#" + vis_choice_id + " ul").on("click", function () {
        vis_choice_id = $(this).closest("div").prop("id");
        id = vis_choice_id.substring(vis_choice_id.length-1);
        $("#display-panel" + id + " .display-vis").attr("style", "display: block; width:100%;");
        $("#display-panel" + id + " .display-query").attr("style", "display: none");

        // set up visualization configuration
        config = {};
        $("#" + vis_choice_id + " ul li input:checked").each(function() {
          if ($(this).attr('name').startsWith("vis_type"));
            config["vis_type"] = parseInt($(this).attr("value"));
          if ($(this).attr('name').startsWith("vis_data"))
            config["vis_data"] = parseInt($(this).attr("value"));
        });

        // the target data used for visualization
        data = null;
        if (config["vis_data"] == 1) {
          // the target visualization data is the example output
          output_table_panel_id = "otable_" + panel_id;
          table_content = get_generated_table_content("otable_" + panel_id)["table_content_str"];
          data = d3.csvParse(table_content);
        } else if (config["vis_data"] == 2) {
          // the target visualization data is the full output (execute the query on database)
          data = $("#display-panel" + id + " .display-vis").prop("full_data");
          if (data == null) {
            query_to_be_run = $("#display-panel" + id + " .display-query pre span").prop("textContent");
            alert(query_to_be_run);
            data = $("#display-panel" + id + " .display-vis").prop("preloaded_data");
          }
        }
        // visualize data on the target div (specified by its id), visualization type specified in config
        if (data != null) {
          build_visualization(data, "#display-panel" + id + " .display-vis", config["vis_type"]);
        }
      });
    });

    // redraw the chart when data changes in the example output
    $(function() {
      $("#otable_" + panel_id).on("change", function() {
        id = this.id.substring(this.id.length - 1);
      });
    });
    $("#panel" + panel_id).height(Math.max($("#input-example" + panel_id).height(), 
                                           $("#output-example" + panel_id).height(), 20));
  });
});

$(function() {
  $('#remove_panel').click(function () {
    $("#interactive-panels .ipanel:last").remove();
  });
});

</script>
</html>
